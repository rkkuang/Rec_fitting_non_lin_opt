% This script is used to collects the experimental data:
% including the physical size measurement data and
% the pixel size data computed from image processing and rectangle fitting.
% Then the linear regression of physical and pixel sizes by OLS and BCES 
% estimator are finished. The results are ploted to figure.


pL_size1_ld=[608.989481510861,609.991186192016,610.445209788948,609.717093489501,608.543421310076,606.231064532507,605.625985002995,604.411686133172,556.710828986395,603.034613471087,602.942591127915,635.094158867643,604.190390912239,606.008650377133,607.712248626567,608.011859064700,608.632415426849,608.508262766407,607.734514823057,606.651651176838,604.943473238927,603.894777232005,603.062085961006,602.526009206487,432.076983907134,603.531049202658,602.661808601973,603.453801460813,605.524716936752,606.645062238493];
pW_size1_ld=[430.376255331990,430.348022210211,429.906355111567,429.360155081280,429.442607422875,430.581033586305,431.296866000772,431.854493041621,433.305155940187,380.548935057839,432.126413771736,432.285583813700,432.169309411919,432.674745118468,432.423910970480,430.757199422352,430.189367965008,429.706192649972,429.349166941461,429.653431205108,430.466816763941,431.190132621142,431.459919762629,431.736268678824,357.605728003557,431.981541938436,430.256119018655,430.538905856046,430.379398389442,430.216768033974];

pL_size1_mid = [601.325325620472,600.643447385018,600.066357250641,600.417041450568,542.161434323621,600.949415954463,601.528262836254,601.776387248984,601.962978590868,634.573476530959,603.041314421620,603.318127671677,601.171854841470,601.177975932258,600.942559452941,600.767477276317,600.580963808287,600.570140917420,600.908767544103,601.617719600587,601.934752296290,602.073521614477,602.074712976072,602.294159229379,601.725204958722,601.553608820781,601.452504446043,644.952440216280,600.947930033780,529.352602264447];
pW_size1_mid = [429.793715417774,429.298458565095,453.646881984795,428.800022022818,488.004881373963,429.234089651856,429.580394826419,429.456699930773,428.933989363199,428.926366085206,428.920488569477,429.136009769257,429.526644064644,429.692142020810,429.573513495335,429.094173775100,428.756735754810,454.690028511033,428.603191195699,428.787396390682,429.236077556937,429.578171222344,429.522292617939,429.454908114595,428.930284642489,428.807690846678,428.410797565434,428.819333050937,429.041189388210,429.582267176626];

pL_size1_ru=[602.531241261394,603.604581251606,505.516842891693,649.744458350585,604.688826221290,604.869567674851,604.629265367591,603.253470794085,602.288000051104,601.612817902349,661.313974988059,652.540422968758,601.107800723576,550.087971377904,602.684628954456,604.492624363666,604.629275811446,605.383188398321,645.504670956357,604.222669764707,603.182869303285,601.696776670338,601.289095475036,601.478979896098,669.469495321315,603.295442568498,604.296516556080,549.951743414312,605.174617251942,605.025765287704];
pW_size1_ru=[430.403801459444,429.785625169145,429.311803806691,380.287294820980,428.910619810330,460.776396157239,430.141645659645,430.192177297983,429.961823965346,430.125170138593,430.110279121687,429.988363824571,429.531169736974,429.919646278171,429.917666224165,429.441434168231,429.254458257492,429.369494547805,429.617019557974,430.541630304322,430.925429934098,429.930968678176,429.936306183800,364.175080353632,361.447838082427,430.741497900554,430.174132149158,429.335498235668,428.981630056307,429.341218459358];

pL_size2_ld=[972.069221458483,974.775668594074,974.291822076501,975.304667873691,697.241640238692,972.919288726609,970.886711432941,970.890979756581,968.964665657142,890.346754362660,966.874002998103,968.178810709651,968.902753620744,956.166701928484,969.438322600857,971.566641115353,975.317037433811,973.158693550588,975.202686622265,972.720050272271,971.082355094372,881.852826546755,969.075736753420,970.031049486393,969.135813957104,968.889987407579,969.519610635684,971.637679969230,878.583703198115,973.482321520484];
pW_size2_ld=[243.186613614187,243.024323380736,242.684804517042,242.639909761646,220.724892247411,242.303113147298,242.744977868560,243.501078447624,243.544106647035,233.736591239440,242.660323720033,242.605716612839,242.693467887952,241.752454908381,243.178387307083,243.120195478746,243.040371452975,242.492484420360,242.358242294502,242.486583957943,242.572654115846,243.021177942319,243.680472966244,243.740230205939,243.564563894615,243.106594324902,6.68266174218212e-07,243.142730430947,243.510671430292,243.541317200732];

pL_size2_mid = [969.096122074223,969.304551743954,969.013733674871,969.046823079487,969.461952141896,969.662886157260,969.889220409080,970.186851260232,970.605508435433,880.905783218845,971.961369501210,971.740088961552,969.698393764228,971.528073159042,969.420646370421,966.531408768448,966.283070146410,966.446072455088,966.715135177582,966.378061576397,966.025090063652,879.810435605861,966.285289341553,969.044050149990,968.646548592060,968.496540242859,968.429770043357,968.145675888304,967.051090007931,966.199573277429];
pW_size2_mid = [243.475487840354,243.211135061545,132.214965819867,242.732311130193,242.506235067600,242.179957933387,242.198747438302,242.388533658584,242.627503058561,243.013994396540,243.334074035900,243.240976159279,242.569418447141,242.114352276806,115.490327900544,242.338535992538,242.747208952525,243.018952396206,242.764975577860,243.184331241581,242.631816722761,242.456599025262,242.172548440138,242.266687039721,242.417342052474,242.816047473912,243.217413259972,243.031106145124,242.248415364880,3.50672042776916e-06];

pL_size2_ru=[905.994041944210,923.878659908909,466.203485573252,857.010713387939,928.900496231270,965.757031039843,965.807900747082,463.786990018305,1181.17034589554,958.695652935197,688.088536117580,894.044006930954,806.482686953026,968.344409476535,948.471240467232,562.823475808417,3.17983074244573e-05,971.257259252765,972.719857396694,972.637709163179,970.402729618972,816.473957638412,973.962250263963,973.334430714071,974.773553711342,972.547604681352,971.568972161154,971.261781012480,971.174185911327,969.667232860273];
pW_size2_ru=[6.09954177702318e-07,238.648108300686,4.36219866857437e-05,242.535654131526,5.00774578683468e-07,1.49483459990941e-05,241.375609170844,5.81735305019681e-06,223.160663880992,241.795448053474,3.70018252819516e-07,237.154396950266,5.13542757293744e-06,133.921373109687,240.797430609973,239.598988472393,3.93122012809958e-06,243.101252113472,242.483981799903,242.304348507807,242.093663723076,241.574573230609,242.736215698821,243.007883631053,126.860558730335,177.050688769932,242.788915525448,242.776317746864,8.95027555584542e-07,243.620291559466];

pL_size3_ld=[1126.78979323643,1127.88929963587,1126.42000886168,1127.88676008496,1048.05082428323,1129.40748953854,1127.00175074802,1125.46396902774,1125.04087239705,1126.11796172579,1125.59398878490,1048.87643731758,1127.15440973902,1127.34179078505,1126.65531322879,932.728090078951,1128.26551992847,1127.64971729541,1127.42725720297,1127.01390667128,1124.97911725528,1125.07157153379,1124.26283935232,1123.31755885285,1123.41919398661,1151.75487592540,1124.54414530315,1126.07864275094,1127.27416276506,1126.12804753408];
pW_size3_ld=[368.648068743167,368.803598194029,368.119128007213,367.710091418704,367.735925660076,368.107837863383,321.354584450438,369.755902845645,370.219344147016,370.366315707122,369.911312324009,369.209169746150,368.662178543406,368.453625367035,368.376287139099,367.057700782417,368.020926273056,417.851455780328,367.729193400971,367.719393509317,318.493508852645,368.157311495739,368.314617805903,320.865115300130,368.813707594184,329.129606322072,368.339524984942,368.372114294221,369.057070583629,311.988162673912];

pL_size3_mid=[1122.18722241607,1122.40519969244,1122.14338730881,1121.90323773386,1121.71424920928,1119.01144363015,1108.26482380336,1121.77993269665,1121.46714004771,1121.45518019921,1121.26943177840,1082.77277805899,1121.82265355700,988.291894706027,947.952800132154,872.149755348334,1102.67158810851,1120.70792419798,1121.56742031712,1121.82026717274,1122.05568991070,857.197631180894,1107.74088941113,1122.19556562439,1058.60472566079,1122.64427021267,1123.10263138526,1123.55595841102,1123.68027354414,1122.95032781498];
pW_size3_mid=[368.564067160411,368.400486612325,368.103644460444,367.645027266863,367.428980824552,366.526972152433,363.906456057678,367.459171865066,367.659629411199,367.846914745161,368.194933435141,1.53901031252729e-05,368.629673276938,343.962572216067,363.586956871719,364.280242152621,365.143949966522,367.270988493652,367.937737464522,368.430878344443,368.532162264681,363.187751423860,364.832216026028,367.552130654056,1.49450168838052e-05,367.426818197752,367.786587463719,368.459208260661,368.364333675795,367.752454064819];

pL_size3_ru=[1122.66149679693,368.628089790172,1080.92175109851,2.44995890947070e-05,830.859614131509,1010.35858485609,1149.75591414404,1156.56340641923,1124.60044432153,921.421451551207,1121.78447588537,1121.71623107641,1121.26698422627,381.444279990903,1122.18695374172,629.567762409275,1090.36068374433,1122.43812464876,1122.64502873918,1122.87627373363,1122.35490657518,1122.36925987842,1122.53428582259,1180.79507944550,518.633373174895,1116.21011382396,1121.35765254034,1122.28275003289,1120.83057248436,1123.59719575529];
pW_size3_ru=[368.872430928435,3.96364074574710e-05,356.041434959328,2.74829279935066e-06,331.397968143733,362.014136289596,366.494539565018,365.628766698226,358.211351270932,224.733431799970,368.164927867183,367.810686014615,368.118557014630,367.191398175807,369.287670834532,254.833273397154,366.485898070529,368.027098776970,367.891104655483,367.965410981240,399.755000725845,443.207128777220,368.701186932146,368.977898364536,367.579346436134,366.355542454018,368.192384010028,368.856948405560,368.441786445024,369.141215260440];


%These are physical widths and lengths of work pieces measured by a micro meter.
rL_size1=[9.718,9.723,9.715,9.721,9.723,9.724,9.722,9.722,9.724,9.720,9.722,9.716,9.724,9.720,9.723,9.720,9.724,9.723,9.724,9.719];
rW_size1=[6.987,6.984,6.991,6.985,6.984,6.982,6.990,6.991,6.990,6.991,6.986,6.990,6.986,6.984,6.986,6.989,6.990,6.991,6.984,6.986];

rL_size2=[15.659,15.632,15.643,15.640,15.635,15.638,15.641,15.643,15.637,15.632,15.643,15.638,15.635,15.634,15.645, 15.633,15.632,15.638,15.634,15.641];
rW_size2=[3.986,3.988,3.994,3.988,3.994,3.994,3.991,3.990,3.991,3.989,3.993,3.995,3.993,3.991,3.989,3.994,3.990,3.989,3.991,3.993];

rL_size3=[18.040, 18.047,18.046,18.042,18.044,18.041,18.036,18.039,18.036,18.038,18.043,18.042,18.035,18.046,18.044,18.043,18.045,18.049,18.036,18.042];
rW_size3=[6.009,6.008,6.002,6.003,6.007,6.008,6.005,6.007,6.010,6.009,6.010,6.006,6.009,6.008,6.009,6.010,6.009,6.008,6.009,6.010];

meanrL_size1 = mean(rL_size1);
meanrW_size1 = mean(rW_size1);

meanrL_size2 = mean(rL_size2);
meanrW_size2 = mean(rW_size2);

meanrL_size3 = mean(rL_size3);
meanrW_size3 = mean(rW_size3);

stdrL_size1 = std(rL_size1);
stdrW_size1 = std(rW_size1);
 
stdrL_size2 = std(rL_size2);
stdrW_size2 = std(rW_size2);
 
stdrL_size3 = std(rL_size3);
stdrW_size3 = std(rW_size3);

%exclude images which are noisy during the edge detection pipline.
pL_size1_ld([25,12,10,9])=[];
pW_size1_ld([25,12,10,9])=[];

pL_size1_mid([30,28,18,10,5,3])=[];
pW_size1_mid([30,28,18,10,5,3])=[];

pL_size1_ru([28,25,24,23,19,14,12,11,6,4,3])=[];
pW_size1_ru([28,25,24,23,19,14,12,11,6,4,3])=[];

pL_size2_ld([29,27,22,14,10,8,5])=[];
pW_size2_ld([29,27,22,14,10,8,5])=[];

pL_size2_mid([30,22,15,10,3])=[];
pW_size2_mid([30,22,15,10,3])=[];

pL_size2_ru([29,26,25,24,22,17,16,15,14,13,12,11,10,9,8,6,5,4,3,2,1])=[];
pW_size2_ru([29,26,25,24,22,17,16,15,14,13,12,11,10,9,8,6,5,4,3,2,1])=[];

pL_size3_ld([30,26,24,21,18,16,12,7,5])=[];
pW_size3_ld([30,26,24,21,18,16,12,7,5])=[];

pL_size3_mid([25,22,23,17,16,15,14,12,10,7])=[];
pW_size3_mid([25,22,23,17,16,15,14,12,10,7])=[];

pL_size3_ru([26,25,24,22,21,17,16,14,10,9,8,7,6,5,4,3,2])=[];
pW_size3_ru([26,25,24,22,21,17,16,14,10,9,8,7,6,5,4,3,2])=[];

%compute the mean pixel width and length of each work pieces
meanpL_size1_ld = mean(pL_size1_ld);
meanpW_size1_ld = mean(pW_size1_ld);

meanpL_size1_mid = mean(pL_size1_mid);
meanpW_size1_mid = mean(pW_size1_mid);

meanpL_size1_ru = mean(pL_size1_ru);
meanpW_size1_ru = mean(pW_size1_ru);

meanpL_size2_ld = mean(pL_size2_ld);
meanpW_size2_ld = mean(pW_size2_ld);
 
meanpL_size2_mid = mean(pL_size2_mid);
meanpW_size2_mid = mean(pW_size2_mid);
 
meanpL_size2_ru = mean(pL_size2_ru);
meanpW_size2_ru = mean(pW_size2_ru);

meanpL_size3_ld = mean(pL_size3_ld);
meanpW_size3_ld = mean(pW_size3_ld);
 
meanpL_size3_mid = mean(pL_size3_mid);
meanpW_size3_mid = mean(pW_size3_mid);
 
meanpL_size3_ru = mean(pL_size3_ru);
meanpW_size3_ru = mean(pW_size3_ru);

allmean = [meanpL_size1_ld,meanpL_size1_mid,meanpL_size1_ru;...
    meanpW_size1_ld,meanpW_size1_mid,meanpW_size1_ru;...
meanpL_size2_ld,meanpL_size2_mid,meanpL_size2_ru;...
    meanpW_size2_ld,meanpW_size2_mid,meanpW_size2_ru;...
meanpL_size3_ld,meanpL_size3_mid,meanpL_size3_ru;...
    meanpW_size3_ld,meanpW_size3_mid,meanpW_size3_ru;... 
    ];

%compute the standard deviation of pixel width and length of each work pieces
stdpL_size1_ld = std(pL_size1_ld);
stdpW_size1_ld = std(pW_size1_ld);

stdpL_size1_mid = std(pL_size1_mid);
stdpW_size1_mid = std(pW_size1_mid);
 
stdpL_size1_ru = std(pL_size1_ru);
stdpW_size1_ru = std(pW_size1_ru);
 
stdpL_size2_ld = std(pL_size2_ld);
stdpW_size2_ld = std(pW_size2_ld);
 
stdpL_size2_mid = std(pL_size2_mid);
stdpW_size2_mid = std(pW_size2_mid);
 
stdpL_size2_ru = std(pL_size2_ru);
stdpW_size2_ru = std(pW_size2_ru);
 
stdpL_size3_ld = std(pL_size3_ld);
stdpW_size3_ld = std(pW_size3_ld);
 
stdpL_size3_mid = std(pL_size3_mid);
stdpW_size3_mid = std(pW_size3_mid);
 
stdpL_size3_ru = std(pL_size3_ru);
stdpW_size3_ru = std(pW_size3_ru);

allstd = [stdpL_size1_ld,stdpL_size1_mid,stdpL_size1_ru;...
    stdpW_size1_ld,stdpW_size1_mid,stdpW_size1_ru;...
stdpL_size2_ld,stdpL_size2_mid,stdpL_size2_ru;...
    stdpW_size2_ld,stdpW_size2_mid,stdpW_size2_ru;...
stdpL_size3_ld,stdpL_size3_mid,stdpL_size3_ru;...
    stdpW_size3_ld,stdpW_size3_mid,stdpW_size3_ru;... 
    ];

meanpL_size1 = mean([pL_size1_ld,pL_size1_mid,pL_size1_ru]);
meanpW_size1 = mean([pW_size1_ld,pW_size1_mid,pW_size1_ru]);
meanpL_size2 = mean([pL_size2_ld,pL_size2_mid,pL_size2_ru]);
meanpW_size2 = mean([pW_size2_ld,pW_size2_mid,pW_size2_ru]);
meanpL_size3 = mean([pL_size3_ld,pL_size3_mid,pL_size3_ru]);
meanpW_size3 = mean([pW_size3_ld,pW_size3_mid,pW_size3_ru]);
allmean2 = [meanpL_size1,meanpW_size1;meanpL_size2,meanpW_size2;meanpL_size3,meanpW_size3];

stdpL_size1 = std([pL_size1_ld,pL_size1_mid,pL_size1_ru]);
stdpW_size1 = std([pW_size1_ld,pW_size1_mid,pW_size1_ru]);
stdpL_size2 = std([pL_size2_ld,pL_size2_mid,pL_size2_ru]);
stdpW_size2 = std([pW_size2_ld,pW_size2_mid,pW_size2_ru]);
stdpL_size3 = std([pL_size3_ld,pL_size3_mid,pL_size3_ru]);
stdpW_size3 = std([pW_size3_ld,pW_size3_mid,pW_size3_ru]);
allstd2 = [stdpL_size1,stdpW_size1;stdpL_size2,stdpW_size2;stdpL_size3,stdpW_size3];

%prepare the pixel and physical size data to do the linear regression.
x = [meanpL_size1_mid,meanpL_size2_mid,meanpL_size3_mid];
y = [meanrL_size1,meanrL_size2,meanrL_size3];
xe = [stdpL_size1_mid,stdpL_size2_mid,stdpL_size3_mid];
ye = [stdrL_size1,stdrL_size2,stdrL_size3];
x2 = [meanpW_size1_mid,meanpW_size2_mid,meanpW_size3_mid];
y2= [meanrW_size1,meanrW_size2,meanrW_size3];
x2e = [stdpW_size1_mid,stdpW_size2_mid,stdpW_size3_mid];
y2e = [stdrW_size1,stdrW_size2,stdrW_size3];

figure();
errorbar(x,y,ye,ye,xe,xe,'b.');hold on;

sigmaB = 0.003;%Type B uncertainty oringing from the micro meter
%Compute the synthesised uncertainty of the physical size measuring
%results.
ye = sqrt(ye.^2+0.003^2);
y2e = sqrt(y2e.^2+0.003^2);

errorbar(x2,y2,y2e,y2e,x2e,x2e,'r.');hold on;

set(gcf,'color','white');
set(gca,'fontsize',20)
xlabel('Pixel size (pixel)','fontsize',28);
ylabel('Physical size (mm)','fontsize',28);
title('Physical and pixel length and width of 3 different workpieces','fontsize',28);
hold on;

%prepare the pixel(X) and physical(Y) size and their errors data to do the linear regression.
X = [x,x2];
Y = [y,y2];
Xe = [xe,x2e];
Ye = [ye,y2e];

plotx = 0:(max(X)+min(X))/10:max(X)+min(X);

A = [ones(length(X),1),X'];

Varx = mean((X-mean(X)).^2);
Vary = mean((Y-mean(Y)).^2);
Covxy = mean((X-mean(X)).*(Y-mean(Y)));
%OLS fitting y|x
k2=Covxy/Varx;
b2=mean(Y)-k2*mean(X);
ploty_olsyx = k2*plotx + b2;

plot(plotx,ploty_olsyx,'g');hold on;

% evaluate the fitting result
preY2 = k2*X + b2;
SStot2 = sum((Y-mean(Y)).^2);
SSreg2 = sum((preY2-mean(Y)).^2);
SSres2 = sum((preY2-Y).^2);
R2_2 = 1-SSres2/SStot2;

% BCES fitting
sigmaxy=0;
sigmax2 = mean((Xe).^2);
k4=(Covxy-sigmaxy)/(Varx-sigmax2);
b4=mean(Y)-k4*mean(X);
ploty_bces = k4*plotx + b4;

%evaluate the fitting result
preY4 = k4*X + b4;
SStot4 = sum((Y-mean(Y)).^2);
SSreg4 = sum((preY4-mean(Y)).^2);
SSres4 = sum((preY4-Y).^2);
R2_4 = 1-SSres4/SStot4;

plot(plotx,ploty_bces,'r');hold on;
legend('length','width','OLS','BCES','Location','southeast');
axes('Position',[0.2,0.55,0.3,0.35]);
errorbar(X([6]),Y([6]),Ye([6]),Ye([6]),Xe([6]),Xe([6]),'r.');hold on;
plot(plotx(3:6),ploty_olsyx(3:6),'g');hold on;
plot(plotx(3:6),ploty_bces(3:6),'r');hold on;